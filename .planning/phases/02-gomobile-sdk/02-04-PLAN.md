---
phase: 02-gomobile-sdk
plan: 04
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - sdk/mobile/internal/device/context.go
  - sdk/mobile/internal/device/id.go
  - sdk/mobile/internal/identity/user.go
  - sdk/mobile/internal/device/context_test.go
  - sdk/mobile/internal/device/id_test.go
  - sdk/mobile/internal/identity/user_test.go
autonomous: true

must_haves:
  truths:
    - "Device ID is generated on first launch and persisted"
    - "Device context is collected without extra permissions"
    - "User identity can be set and cleared"
    - "ResetAll regenerates device ID"
  artifacts:
    - path: "sdk/mobile/internal/device/context.go"
      provides: "Device context collection (OS, model, locale, etc.)"
      exports: ["CollectContext", "DeviceContext"]
    - path: "sdk/mobile/internal/device/id.go"
      provides: "Device ID generation and persistence"
      exports: ["GetOrCreateDeviceID", "RegenerateDeviceID"]
    - path: "sdk/mobile/internal/identity/user.go"
      provides: "User identity management"
      exports: ["NewIdentityManager", "SetUser", "GetUser", "Reset"]
  key_links:
    - from: "sdk/mobile/internal/device/id.go"
      to: "sdk/mobile/internal/storage/db.go"
      via: "SQLite persistence for device ID"
      pattern: "storage\\.DB"
---

<objective>
Implement device context collection, device ID management, and user identity tracking.

Purpose: Device context enriches every event with platform information. Device ID provides anonymous tracking. User identity enables cross-device correlation when users log in. Privacy-first design uses app-scoped device ID by default.

Output: `sdk/mobile/internal/device/` and `sdk/mobile/internal/identity/` packages.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-gomobile-sdk/02-CONTEXT.md
@.planning/phases/02-gomobile-sdk/02-RESEARCH.md
@.planning/phases/02-gomobile-sdk/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement device context and ID management</name>
  <files>
    sdk/mobile/internal/device/context.go
    sdk/mobile/internal/device/id.go
  </files>
  <action>
**sdk/mobile/internal/device/context.go:**

DeviceContext struct (all fields JSON-serializable):
- DeviceID string
- Platform string (set by native wrapper: "ios" or "android")
- OSVersion string (set by native wrapper)
- DeviceModel string (set by native wrapper)
- DeviceManufacturer string (set by native wrapper)
- AppVersion string (set by native wrapper)
- AppBuildNumber string (set by native wrapper)
- ScreenWidth int
- ScreenHeight int
- Locale string
- Timezone string
- SDKVersion string (hardcoded, e.g., "1.0.0")
- Carrier string (optional, if available)
- NetworkType string (optional: wifi, cellular, offline)

CollectContext() *DeviceContext:
- Return DeviceContext with Go-available fields (SDKVersion)
- Platform-specific fields are populated by native wrappers via SetPlatformContext

SetPlatformContext(platform, osVersion, model, manufacturer, appVersion, buildNumber string, screenW, screenH int, locale, timezone string):
- Called by native wrappers on init
- Stores in package-level variable (protected by sync.Once or mutex)

GetContext() *DeviceContext:
- Return current context with device ID from id manager

**sdk/mobile/internal/device/id.go:**

IDManager struct:
- db *storage.DB (for persistence)
- deviceID string (cached)
- mu sync.RWMutex
- persistent bool (whether to use Keychain/EncryptedPrefs - default false)

NewIDManager(db *storage.DB, persistent bool) *IDManager

GetOrCreateDeviceID() string:
- RLock: if cached deviceID not empty, return it
- Lock: check DB for existing ID
- If found: cache and return
- If not found: generate UUID, store in DB, cache, return
- Storage table: device_info(key TEXT PRIMARY KEY, value TEXT)

RegenerateDeviceID() string:
- Lock
- Generate new UUID
- Update DB
- Update cache
- Unlock
- Return new ID (for ResetAll scenario)

DB schema addition (in migrations):
```sql
CREATE TABLE IF NOT EXISTS device_info (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL
);
```

Note: Keychain/EncryptedPrefs integration happens in native wrappers.
Go layer only handles SQLite-based persistence.
The `persistent` flag is passed through for native wrappers to decide storage.
  </action>
  <verify>
    - `go build ./sdk/mobile/internal/device/` compiles
    - No external dependencies beyond stdlib and uuid
  </verify>
  <done>
    - Device context struct captures all required fields
    - Device ID generated once and cached
    - Device ID persisted to SQLite
    - RegenerateDeviceID works for ResetAll
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement user identity management with tests</name>
  <files>
    sdk/mobile/internal/identity/user.go
    sdk/mobile/internal/device/context_test.go
    sdk/mobile/internal/device/id_test.go
    sdk/mobile/internal/identity/user_test.go
  </files>
  <action>
**sdk/mobile/internal/identity/user.go:**

UserIdentity struct:
- UserID string (optional, set by app)
- Traits map[string]interface{} (custom user properties)
- Aliases []string (optional, for identity resolution)

IdentityManager struct:
- mu sync.RWMutex
- current *UserIdentity
- db *storage.DB (for persistence)

NewIdentityManager(db *storage.DB) *IdentityManager

SetUser(userID string, traits map[string]interface{}, aliases []string) error:
- Lock
- Create UserIdentity
- Persist to DB (JSON-encoded)
- Cache
- Unlock

GetUser() *UserIdentity:
- RLock, return copy of current, RUnlock
- Returns nil if no user set

Reset():
- Lock
- Clear current identity
- Delete from DB
- Keep device ID intact (soft reset)
- Unlock

LoadFromDB() error:
- Called on SDK init
- Load persisted user identity if exists

DB storage: use device_info table with key="user_identity"

**Tests:**

**sdk/mobile/internal/device/context_test.go:**
- TestCollectContext_ReturnsSDKVersion
- TestSetPlatformContext_StoresValues
- TestGetContext_IncludesDeviceID

**sdk/mobile/internal/device/id_test.go:**
- TestGetOrCreateDeviceID_CreatesOnFirstCall
- TestGetOrCreateDeviceID_ReturnsSameOnSecondCall
- TestGetOrCreateDeviceID_PersistsAcrossInstances (close DB, reopen, verify same ID)
- TestRegenerateDeviceID_ReturnsDifferentID
- TestConcurrentAccess_Safe (multiple goroutines)

**sdk/mobile/internal/identity/user_test.go:**
- TestSetUser_StoresIdentity
- TestGetUser_ReturnsSetIdentity
- TestGetUser_ReturnsNilIfNotSet
- TestReset_ClearsIdentity
- TestLoadFromDB_RestoresIdentity
- TestConcurrentAccess_Safe

Use t.TempDir() for test database files.
  </action>
  <verify>
    - `go test ./sdk/mobile/internal/device/... -v -race` passes
    - `go test ./sdk/mobile/internal/identity/... -v -race` passes
    - Combined coverage >= 80%
  </verify>
  <done>
    - User identity persists across app restarts
    - Reset clears user but keeps device ID
    - All tests pass with no data races
    - Coverage >= 80%
  </done>
</task>

</tasks>

<verification>
- Build: `go build ./sdk/mobile/internal/device/` and `go build ./sdk/mobile/internal/identity/`
- Tests: `go test ./sdk/mobile/internal/device/... ./sdk/mobile/internal/identity/... -v -race`
- Coverage: `go test ./sdk/mobile/internal/device/... ./sdk/mobile/internal/identity/... -cover`
</verification>

<success_criteria>
- Device ID generated once on first launch
- Device ID persists in SQLite
- Device context captures platform info (populated by native wrappers)
- User identity can be set, retrieved, and cleared
- Reset clears user but keeps device ID (soft reset)
- RegenerateDeviceID creates new ID (for ResetAll)
- Tests pass with no data races, >= 80% coverage
</success_criteria>

<output>
After completion, create `.planning/phases/02-gomobile-sdk/02-04-SUMMARY.md`
</output>
