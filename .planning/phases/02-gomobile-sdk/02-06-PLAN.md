---
phase: 02-gomobile-sdk
plan: 06
type: execute
wave: 4
depends_on: ["02-01", "02-02", "02-03", "02-04", "02-05"]
files_modified:
  - sdk/mobile/sdk.go
  - sdk/mobile/sdk_test.go
  - Makefile
  - scripts/gomobile-build.sh
autonomous: true

must_haves:
  truths:
    - "gomobile bind produces .xcframework for iOS"
    - "gomobile bind produces .aar for Android"
    - "SDK integrates all internal components"
    - "Build is reproducible with pinned versions"
  artifacts:
    - path: "sdk/mobile/sdk.go"
      provides: "SDK singleton wiring all components"
      exports: ["Init", "Track", "SetUser", "Reset", "ResetAll", "Flush", "GetDeviceId"]
    - path: "Makefile"
      provides: "Build targets for gomobile"
      contains: "gomobile bind"
    - path: "scripts/gomobile-build.sh"
      provides: "Reproducible build script"
  key_links:
    - from: "sdk/mobile/sdk.go"
      to: "sdk/mobile/internal/storage"
      via: "Storage initialization"
      pattern: "storage\\.NewDB"
    - from: "sdk/mobile/sdk.go"
      to: "sdk/mobile/internal/batch"
      via: "Batcher initialization"
      pattern: "batch\\.NewBatcher"
    - from: "sdk/mobile/sdk.go"
      to: "sdk/mobile/internal/session"
      via: "Session tracker initialization"
      pattern: "session\\.NewTracker"
---

<objective>
Wire all SDK components together and set up gomobile build infrastructure.

Purpose: This plan integrates storage, batching, transport, session, device, and identity into a cohesive SDK. It also creates build scripts and Makefile targets for reproducible gomobile builds that produce .xcframework and .aar artifacts.

Output: Complete SDK wiring in `sdk/mobile/sdk.go`, Makefile targets, and build scripts.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-gomobile-sdk/02-CONTEXT.md
@.planning/phases/02-gomobile-sdk/02-RESEARCH.md
@.planning/phases/02-gomobile-sdk/02-01-SUMMARY.md
@.planning/phases/02-gomobile-sdk/02-02-SUMMARY.md
@.planning/phases/02-gomobile-sdk/02-03-SUMMARY.md
@.planning/phases/02-gomobile-sdk/02-04-SUMMARY.md
@.planning/phases/02-gomobile-sdk/02-05-SUMMARY.md
@Makefile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire SDK components and implement exported functions</name>
  <files>
    sdk/mobile/sdk.go
    sdk/mobile/sdk_test.go
  </files>
  <action>
**sdk/mobile/sdk.go:**

SDK struct (package-level singleton):
- config *Config
- db *storage.DB
- queue *storage.Queue
- idManager *device.IDManager
- identityManager *identity.IdentityManager
- sessionTracker *session.Tracker
- batcher *batch.Batcher
- transport *transport.Client
- deviceContext *device.DeviceContext
- initialized bool
- mu sync.RWMutex

var (
  instance *SDK
  initOnce sync.Once
)

Init(configJSON string) string:
- Parse config via bridge.parseConfig
- Validate config
- initOnce.Do:
  - Open DB at platform-specific path (passed in config or default)
  - Create queue with maxQueueSize from config
  - Create ID manager
  - Create identity manager, load from DB
  - Create session tracker if enabled
  - Create transport client
  - Create batcher, start flush loop
  - Store device context
  - Set initialized = true
- Return empty string on success, error message on failure

Track(eventJSON string) string:
- Check initialized
- Parse event via bridge.parseEvent
- Add idempotency key (UUID), timestamp, app_id, device context
- Add session_id from session tracker (if enabled)
- Add user_id from identity manager (if set)
- Record activity on session tracker
- Enqueue via batcher
- Return empty string or error

SetUser(userJSON string) string:
- Check initialized
- Parse user via bridge.parseUser
- Call identity manager SetUser
- Return empty string or error

Reset() string:
- Check initialized
- Call identity manager Reset
- Keep device ID
- Return empty string

ResetAll() string:
- Check initialized
- Clear identity
- Regenerate device ID
- Clear event queue
- End session if active
- Return empty string

Flush() string:
- Check initialized
- Call batcher.Flush with background context
- Return empty string or error

GetDeviceId() string:
- If not initialized, return empty string
- Return ID manager's device ID

IsInitialized() bool:
- Return initialized flag (RLock protected)

SetDebugMode(enabled bool):
- Set debug logging level

// Lifecycle hooks (called by native wrappers)
AppDidEnterBackground() string:
- session tracker AppDidEnterBackground
- Trigger immediate flush for reliability
- Return empty string

AppWillEnterForeground() string:
- session tracker AppWillEnterForeground
- Return empty string

// Platform context (called by native wrappers on init)
SetPlatformContext(platform, osVersion, model, manufacturer, appVersion, buildNumber string, screenW, screenH int, locale, timezone string):
- Call device.SetPlatformContext with provided values

**sdk/mobile/sdk_test.go:**
- TestInit_ValidConfig - verify initialization
- TestInit_InvalidConfig - verify error returned
- TestInit_OnlyOnce - verify singleton behavior
- TestTrack_BeforeInit - verify error
- TestTrack_AfterInit - verify success
- TestTrack_AddsMetadata - verify idempotency key, timestamp, etc.
- TestSetUser_StoresIdentity
- TestReset_ClearsUser
- TestResetAll_ClearsEverything
- TestFlush_SendsEvents
- TestLifecycleHooks - verify background/foreground
  </action>
  <verify>
    - `go build ./sdk/mobile/` compiles
    - `go test ./sdk/mobile/... -v -race` passes
    - No CGO: `go list -f '{{.CgoFiles}}' ./sdk/mobile/...` returns empty
  </verify>
  <done>
    - SDK singleton wires all components
    - Init validates config and initializes components
    - Track adds metadata and enqueues
    - Lifecycle hooks work for background/foreground
    - Tests pass with no data races
  </done>
</task>

<task type="auto">
  <name>Task 2: Create gomobile build infrastructure</name>
  <files>
    Makefile
    scripts/gomobile-build.sh
  </files>
  <action>
**scripts/gomobile-build.sh:**
```bash
#!/bin/bash
set -euo pipefail

# Reproducible gomobile build script
# Requires: Go 1.24+, gomobile, Android NDK (for Android builds)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
BUILD_DIR="$PROJECT_ROOT/build/mobile"
SDK_PACKAGE="github.com/SebastienMelki/causality/sdk/mobile"

# Version pinning
GO_VERSION_MIN="1.24"
ANDROID_API_MIN=21

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

check_go_version() {
    local go_version
    go_version=$(go version | grep -oE 'go[0-9]+\.[0-9]+' | sed 's/go//')
    log_info "Go version: $go_version"
}

check_gomobile() {
    if ! command -v gomobile &> /dev/null; then
        log_error "gomobile not found. Install with: go install golang.org/x/mobile/cmd/gomobile@latest"
        exit 1
    fi
    log_info "gomobile found: $(which gomobile)"
}

init_gomobile() {
    log_info "Initializing gomobile..."
    gomobile init
}

build_ios() {
    log_info "Building iOS XCFramework..."
    mkdir -p "$BUILD_DIR"

    gomobile bind \
        -target ios \
        -prefix CAU \
        -o "$BUILD_DIR/Causality.xcframework" \
        "$SDK_PACKAGE"

    log_info "iOS build complete: $BUILD_DIR/Causality.xcframework"
}

build_android() {
    log_info "Building Android AAR..."
    mkdir -p "$BUILD_DIR"

    # Check for ANDROID_HOME or ANDROID_NDK_HOME
    if [[ -z "${ANDROID_HOME:-}" ]] && [[ -z "${ANDROID_NDK_HOME:-}" ]]; then
        log_warn "ANDROID_HOME not set. Android build may fail."
    fi

    gomobile bind \
        -target android \
        -androidapi "$ANDROID_API_MIN" \
        -javapkg io.causality.mobile \
        -o "$BUILD_DIR/causality.aar" \
        "$SDK_PACKAGE"

    log_info "Android build complete: $BUILD_DIR/causality.aar"
}

build_all() {
    build_ios
    build_android
}

usage() {
    echo "Usage: $0 [ios|android|all]"
    echo "  ios     - Build iOS XCFramework"
    echo "  android - Build Android AAR"
    echo "  all     - Build both (default)"
}

main() {
    check_go_version
    check_gomobile
    init_gomobile

    local target="${1:-all}"

    case "$target" in
        ios)
            build_ios
            ;;
        android)
            build_android
            ;;
        all)
            build_all
            ;;
        *)
            usage
            exit 1
            ;;
    esac

    log_info "Build complete!"
}

main "$@"
```

Make executable: `chmod +x scripts/gomobile-build.sh`

**Makefile additions:**
Add to existing Makefile:

```makefile
# Mobile SDK Build Targets
.PHONY: mobile-ios mobile-android mobile-all mobile-clean

# Install gomobile toolchain
mobile-setup:
	go install golang.org/x/mobile/cmd/gomobile@latest
	gomobile init

# Build iOS XCFramework
mobile-ios:
	./scripts/gomobile-build.sh ios

# Build Android AAR
mobile-android:
	./scripts/gomobile-build.sh android

# Build both platforms
mobile-all:
	./scripts/gomobile-build.sh all

# Clean mobile build artifacts
mobile-clean:
	rm -rf build/mobile

# Test mobile SDK (no CGO verification)
mobile-test:
	go test ./sdk/mobile/... -v -race
	@echo "Verifying no CGO dependencies..."
	@go list -f '{{.CgoFiles}}' ./sdk/mobile/... | grep -v '^\[\]$$' && echo "ERROR: CGO files found!" && exit 1 || echo "OK: No CGO"
```
  </action>
  <verify>
    - `chmod +x scripts/gomobile-build.sh`
    - `make mobile-test` passes (tests + no CGO check)
    - gomobile installed: `go install golang.org/x/mobile/cmd/gomobile@latest && gomobile init`
    - `make mobile-ios` produces build/mobile/Causality.xcframework (on macOS with Xcode)
    - `make mobile-android` produces build/mobile/causality.aar (with Android NDK)
  </verify>
  <done>
    - Build script is executable and documented
    - Makefile has mobile-ios, mobile-android, mobile-all targets
    - Build produces .xcframework and .aar in build/mobile/
    - mobile-test target verifies no CGO dependencies
  </done>
</task>

</tasks>

<verification>
- SDK compiles: `go build ./sdk/mobile/`
- Tests pass: `go test ./sdk/mobile/... -v -race`
- No CGO: `go list -f '{{.CgoFiles}}' ./sdk/mobile/...` returns empty
- Build script: `./scripts/gomobile-build.sh ios` (on macOS)
</verification>

<success_criteria>
- SDK wires all components (storage, batch, transport, session, device, identity)
- Exported functions work correctly (Init, Track, SetUser, Reset, Flush, GetDeviceId)
- Lifecycle hooks (AppDidEnterBackground, AppWillEnterForeground) implemented
- gomobile bind produces .xcframework and .aar
- Build is reproducible with pinned versions
- Tests pass with no data races
</success_criteria>

<output>
After completion, create `.planning/phases/02-gomobile-sdk/02-06-SUMMARY.md`
</output>
