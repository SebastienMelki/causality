---
phase: 02-gomobile-sdk
plan: 11
type: execute
wave: 7
depends_on: ["02-09", "02-10", "02-12"]
files_modified:
  - .planning/phases/02-gomobile-sdk/02-VERIFICATION.md
autonomous: false

must_haves:
  truths:
    - "iOS XCFramework integrates into fresh Xcode project"
    - "Android AAR integrates into fresh Android Studio project"
    - "Events persist through app kill and send on next launch"
    - "SDK flushes on app background"
    - "Device context is auto-populated"
  artifacts:
    - path: "build/mobile/Causality.xcframework"
      provides: "iOS framework"
    - path: "build/mobile/causality.aar"
      provides: "Android library"
  key_links:
    - from: "sdk/ios/Examples/SwiftUIExample"
      to: "build/mobile/Causality.xcframework"
      via: "SPM binaryTarget"
    - from: "sdk/android/examples/compose-example"
      to: "build/mobile/causality.aar"
      via: "Gradle dependency"
---

<objective>
Verify end-to-end SDK integration on both platforms against Phase 2 success criteria.

Purpose: This is the final verification checkpoint that confirms the SDK works in real iOS and Android applications. We verify against the roadmap success criteria to ensure the phase goal is met.

Output: Verified working SDKs on both platforms, verification report.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-gomobile-sdk/02-CONTEXT.md
@.planning/phases/02-gomobile-sdk/02-09-SUMMARY.md
@.planning/phases/02-gomobile-sdk/02-10-SUMMARY.md
@.planning/phases/02-gomobile-sdk/02-12-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build and verify gomobile artifacts</name>
  <files>
    build/mobile/Causality.xcframework
    build/mobile/causality.aar
  </files>
  <action>
Build both mobile artifacts and verify they are valid:

1. Run gomobile build for both platforms:
```bash
make mobile-all
```

2. Verify iOS XCFramework structure:
```bash
ls -la build/mobile/Causality.xcframework/
# Should contain:
# - ios-arm64/
# - ios-arm64_x86_64-simulator/
# - Info.plist
```

3. Verify Android AAR structure:
```bash
unzip -l build/mobile/causality.aar | head -20
# Should contain:
# - classes.jar
# - AndroidManifest.xml
# - jni/ (with .so files for each arch)
```

4. Verify no CGO in final build:
```bash
go list -f '{{.CgoFiles}}' ./sdk/mobile/...
# Should return empty brackets []
```

5. Run Go tests for mobile package:
```bash
go test ./sdk/mobile/... -v -race
```
  </action>
  <verify>
    - XCFramework exists: `test -d build/mobile/Causality.xcframework`
    - AAR exists: `test -f build/mobile/causality.aar`
    - Tests pass: `go test ./sdk/mobile/... -v`
  </verify>
  <done>
    - gomobile build produces valid .xcframework
    - gomobile build produces valid .aar
    - All mobile package tests pass
    - No CGO dependencies
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete gomobile SDK with:
- Go core library (sdk/mobile/)
- iOS XCFramework (build/mobile/Causality.xcframework)
- Android AAR (build/mobile/causality.aar)
- Swift wrapper with async/await (sdk/ios/)
- Kotlin wrapper with coroutines (sdk/android/causality/)
- iOS example apps (UIKit + SwiftUI)
- Android example apps (Views + Compose)
  </what-built>
  <how-to-verify>
**iOS Verification (requires macOS with Xcode):**

1. Start the Causality server:
   ```bash
   make dev
   ```

2. Build the iOS framework:
   ```bash
   make mobile-ios
   ```

3. Open SwiftUI example in Xcode:
   ```bash
   open sdk/ios/Examples/SwiftUIExample
   ```

4. Update endpoint in `SwiftUIExampleApp.swift`:
   ```swift
   endpoint: "http://localhost:8080"
   ```

5. Run on iOS Simulator

6. Verify:
   - [ ] App launches without crash
   - [ ] Device ID is displayed and non-empty
   - [ ] "Track Event" button shows toast "Event tracked!"
   - [ ] "Flush Events" shows toast "Events flushed!"
   - [ ] Events appear in server logs or Trino

7. Test persistence:
   - [ ] Track some events
   - [ ] Kill the app (swipe away from app switcher)
   - [ ] Relaunch the app
   - [ ] Flush events
   - [ ] Verify previously tracked events are sent

**Android Verification (requires Android Studio):**

1. Ensure server is running:
   ```bash
   make dev
   ```

2. Build the Android library:
   ```bash
   make mobile-android
   ```

3. Open Android project in Android Studio:
   ```bash
   cd sdk/android
   # Open in Android Studio
   ```

4. Update endpoint in `ExampleApplication.kt`:
   ```kotlin
   endpoint: "http://10.0.2.2:8080"  // localhost from emulator
   ```

5. Run compose-example on Android Emulator

6. Verify:
   - [ ] App launches without crash
   - [ ] Device ID is displayed and non-empty
   - [ ] "Track Event" button shows snackbar "Event tracked!"
   - [ ] "Flush Events" shows snackbar "Events flushed!"
   - [ ] Events appear in server logs or Trino

7. Test persistence:
   - [ ] Track some events
   - [ ] Force stop the app (Settings > Apps > Force Stop)
   - [ ] Relaunch the app
   - [ ] Flush events
   - [ ] Verify previously tracked events are sent

8. Test background flush:
   - [ ] Track some events
   - [ ] Press home button (app goes to background)
   - [ ] Check server logs for immediate flush

**Success Criteria from Roadmap:**
- [ ] .xcframework integrates into fresh Xcode project and sends events to server
- [ ] .aar integrates into fresh Android Studio project and sends events to server
- [ ] Events persist through app kill and send on next launch
- [ ] SDK flushes on app background
- [ ] Offline events sent when connectivity returns (test with airplane mode)
- [ ] Device context auto-populated (check event payload in server logs)
  </how-to-verify>
  <resume-signal>
Report verification results:
- Type "PASS" if all criteria met
- Type "PARTIAL: [which criteria failed]" if some failed
- Type "FAIL: [reason]" if blocking issues
  </resume-signal>
</task>

<task type="auto">
  <name>Task 3: Create verification report</name>
  <files>
    .planning/phases/02-gomobile-sdk/02-VERIFICATION.md
  </files>
  <action>
Based on verification results, create a verification report documenting:

1. Build verification results
2. iOS integration test results
3. Android integration test results
4. Success criteria checklist
5. Any issues found and their resolution

Template:
```markdown
# Phase 2: gomobile SDK - Verification Report

**Verified:** {date}
**Status:** {PASS | PARTIAL | FAIL}

## Build Verification

| Artifact | Status | Notes |
|----------|--------|-------|
| Causality.xcframework | {PASS/FAIL} | {notes} |
| causality.aar | {PASS/FAIL} | {notes} |
| Go tests | {PASS/FAIL} | {coverage}% |

## iOS Integration

| Criteria | Status |
|----------|--------|
| App launches | {PASS/FAIL} |
| Device ID displayed | {PASS/FAIL} |
| Events track | {PASS/FAIL} |
| Events flush | {PASS/FAIL} |
| Events persist | {PASS/FAIL} |
| Background flush | {PASS/FAIL} |

## Android Integration

| Criteria | Status |
|----------|--------|
| App launches | {PASS/FAIL} |
| Device ID displayed | {PASS/FAIL} |
| Events track | {PASS/FAIL} |
| Events flush | {PASS/FAIL} |
| Events persist | {PASS/FAIL} |
| Background flush | {PASS/FAIL} |

## Roadmap Success Criteria

- [ ] .xcframework integrates and sends events
- [ ] .aar integrates and sends events
- [ ] Events persist through app kill
- [ ] SDK flushes on background
- [ ] Offline events sent on reconnect
- [ ] Device context auto-populated

## Issues

{List any issues found and their resolution}

## Recommendations

{Any recommendations for Phase 3 or future improvements}
```
  </action>
  <verify>
    - Report exists: `cat .planning/phases/02-gomobile-sdk/02-VERIFICATION.md`
  </verify>
  <done>
    - Verification report documents all test results
    - Success criteria clearly marked PASS/FAIL
    - Issues documented with resolution
  </done>
</task>

</tasks>

<verification>
- Build artifacts exist
- Human verification checkpoint passed
- Verification report created
</verification>

<success_criteria>
- gomobile produces valid .xcframework and .aar
- iOS example app sends events to server
- Android example app sends events to server
- Events persist through app lifecycle
- Background flush works on both platforms
- All Phase 2 roadmap success criteria met
</success_criteria>

<output>
After completion, create `.planning/phases/02-gomobile-sdk/02-11-SUMMARY.md`
</output>
