---
phase: 02-gomobile-sdk
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - sdk/mobile/internal/storage/db.go
  - sdk/mobile/internal/storage/queue.go
  - sdk/mobile/internal/storage/migrations.go
  - sdk/mobile/internal/storage/db_test.go
  - sdk/mobile/internal/storage/queue_test.go
  - go.mod
autonomous: true

must_haves:
  truths:
    - "Events persist to SQLite and survive process restart"
    - "Queue returns events in FIFO order"
    - "Old events are evicted when queue is full"
    - "SQLite uses WAL mode for concurrent access"
  artifacts:
    - path: "sdk/mobile/internal/storage/db.go"
      provides: "Database connection and lifecycle management"
      exports: ["NewDB", "Close"]
    - path: "sdk/mobile/internal/storage/queue.go"
      provides: "FIFO event queue with eviction"
      exports: ["NewQueue", "Enqueue", "DequeueBatch", "Delete", "Count"]
    - path: "sdk/mobile/internal/storage/migrations.go"
      provides: "Schema versioning and migrations"
      contains: "CREATE TABLE"
  key_links:
    - from: "sdk/mobile/internal/storage/queue.go"
      to: "sdk/mobile/internal/storage/db.go"
      via: "DB dependency injection"
      pattern: "\\*DB"
    - from: "sdk/mobile/internal/storage/db.go"
      to: "modernc.org/sqlite"
      via: "database/sql driver"
      pattern: 'sql.Open\\("sqlite"'
---

<objective>
Implement SQLite-based persistent event queue using modernc.org/sqlite (CGO-free).

Purpose: Events must survive app kills, crashes, and reboots. SQLite provides ACID guarantees and is the standard mobile persistence solution. Using modernc.org/sqlite (pure Go) is mandatory for gomobile cross-compilation.

Output: `sdk/mobile/internal/storage/` package with queue operations and migrations.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-gomobile-sdk/02-CONTEXT.md
@.planning/phases/02-gomobile-sdk/02-RESEARCH.md
@.planning/phases/02-gomobile-sdk/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SQLite database layer with modernc.org/sqlite</name>
  <files>
    sdk/mobile/internal/storage/db.go
    sdk/mobile/internal/storage/migrations.go
    go.mod
  </files>
  <action>
Add modernc.org/sqlite dependency (MUST use this, not mattn/go-sqlite3 which requires CGO):

```bash
go get modernc.org/sqlite@v1.44.3
```

**sdk/mobile/internal/storage/db.go:**
- DB struct wrapping *sql.DB
- NewDB(dbPath string) (*DB, error):
  - Open with WAL mode: `sql.Open("sqlite", dbPath+"?_pragma=journal_mode(WAL)&_pragma=busy_timeout(5000)")`
  - Run migrations on open
  - Return wrapped DB
- Close() error - close database connection
- Exec, Query, QueryRow wrappers for convenience

**sdk/mobile/internal/storage/migrations.go:**
- Schema version tracking table
- Initial migration (v1):
```sql
CREATE TABLE IF NOT EXISTS events (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    event_json TEXT NOT NULL,
    idempotency_key TEXT NOT NULL UNIQUE,
    created_at INTEGER NOT NULL,
    retry_count INTEGER DEFAULT 0,
    last_retry_at INTEGER DEFAULT 0
);

CREATE INDEX IF NOT EXISTS idx_events_created ON events(created_at);
CREATE INDEX IF NOT EXISTS idx_events_retry ON events(retry_count, last_retry_at);

CREATE TABLE IF NOT EXISTS schema_version (
    version INTEGER PRIMARY KEY
);
```
- runMigrations(db *sql.DB) error - apply pending migrations
- getCurrentVersion(db *sql.DB) (int, error)
- Use transactions for migration safety
  </action>
  <verify>
    - `go mod tidy` succeeds
    - No CGO: `go list -f '{{.CgoFiles}}' ./sdk/mobile/internal/storage/` returns empty
    - `go build ./sdk/mobile/internal/storage/` compiles
  </verify>
  <done>
    - modernc.org/sqlite added to go.mod
    - DB opens with WAL mode and busy timeout
    - Migrations create events table with proper indexes
    - Schema versioning tracks applied migrations
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement FIFO event queue with eviction</name>
  <files>
    sdk/mobile/internal/storage/queue.go
    sdk/mobile/internal/storage/db_test.go
    sdk/mobile/internal/storage/queue_test.go
  </files>
  <action>
**sdk/mobile/internal/storage/queue.go:**
- Queue struct with DB reference and maxSize config
- NewQueue(db *DB, maxSize int) *Queue
- Enqueue(eventJSON string, idempotencyKey string) error:
  - Check queue size, evict oldest if >= maxSize
  - INSERT with created_at = time.Now().UnixMilli()
  - Handle UNIQUE constraint violation (duplicate idempotency key) gracefully
- DequeueBatch(n int) ([]QueuedEvent, error):
  - SELECT oldest n events by created_at
  - Return QueuedEvent{ID, EventJSON, IdempotencyKey, CreatedAt, RetryCount}
- Delete(ids []int64) error:
  - Batch delete by IDs after successful send
- MarkRetry(id int64) error:
  - Increment retry_count, update last_retry_at
- Count() (int, error) - return queue depth
- Clear() error - delete all events (for ResetAll)

QueuedEvent struct:
- ID int64
- EventJSON string
- IdempotencyKey string
- CreatedAt int64 (Unix milliseconds)
- RetryCount int

**sdk/mobile/internal/storage/queue_test.go:**
- TestEnqueue_Success - insert and retrieve
- TestEnqueue_Eviction - insert maxSize+1, verify oldest evicted
- TestEnqueue_DuplicateIdempotencyKey - no error, no duplicate
- TestDequeueBatch_FIFO - verify order
- TestDequeueBatch_Empty - returns empty slice, no error
- TestDelete_RemovesEvents - delete and verify gone
- TestMarkRetry_IncrementsCount - verify retry tracking
- TestCount_Accurate - verify count matches insertions

**sdk/mobile/internal/storage/db_test.go:**
- TestNewDB_CreatesFile - verify file created
- TestNewDB_RunsMigrations - verify tables exist
- TestClose_ReleasesLock - verify can reopen after close

Use t.TempDir() for test database files.
  </action>
  <verify>
    - `go test ./sdk/mobile/internal/storage/... -v` passes
    - `go test ./sdk/mobile/internal/storage/... -cover` shows >= 80% coverage
  </verify>
  <done>
    - Enqueue adds events with automatic eviction at maxSize
    - DequeueBatch returns events in FIFO order
    - Delete removes sent events
    - Duplicate idempotency keys handled gracefully
    - Tests pass with >= 80% coverage
  </done>
</task>

</tasks>

<verification>
- No CGO: `go list -f '{{.CgoFiles}}' ./sdk/mobile/...` returns empty for all packages
- Tests pass: `go test ./sdk/mobile/internal/storage/... -v`
- Coverage: `go test ./sdk/mobile/internal/storage/... -cover`
</verification>

<success_criteria>
- SQLite storage uses modernc.org/sqlite (pure Go, no CGO)
- Events persist to disk in FIFO order
- Queue evicts oldest events when full
- Duplicate idempotency keys are handled without error
- Schema migrations run automatically on DB open
- Tests pass with >= 80% coverage
</success_criteria>

<output>
After completion, create `.planning/phases/02-gomobile-sdk/02-02-SUMMARY.md`
</output>
