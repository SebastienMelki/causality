---
phase: 02-gomobile-sdk
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sdk/mobile/causality.go
  - sdk/mobile/config.go
  - sdk/mobile/bridge.go
  - sdk/mobile/errors.go
  - sdk/mobile/callbacks.go
  - sdk/mobile/events.go
autonomous: true

must_haves:
  truths:
    - "Go mobile package compiles without CGO"
    - "JSON config can initialize SDK state"
    - "Exported functions use only gomobile-compatible types"
    - "Critical failures trigger registered error callbacks"
    - "Event types provide compile-time validation via typed structs"
  artifacts:
    - path: "sdk/mobile/causality.go"
      provides: "Init, Track, SetUser, Reset, Flush, GetDeviceId exports"
      exports: ["Init", "Track", "SetUser", "Reset", "Flush", "GetDeviceId"]
    - path: "sdk/mobile/config.go"
      provides: "Configuration struct with JSON tags"
      contains: "type Config struct"
    - path: "sdk/mobile/bridge.go"
      provides: "JSON marshal/unmarshal helpers"
      exports: ["parseConfig", "parseEvent", "parseUser"]
    - path: "sdk/mobile/errors.go"
      provides: "Error constants, severity levels, and error response helpers"
      contains: "ErrorSeverity"
    - path: "sdk/mobile/callbacks.go"
      provides: "Error callback registration for critical failures"
      exports: ["RegisterErrorCallback", "ErrorCallback"]
    - path: "sdk/mobile/events.go"
      provides: "Typed event structs matching proto schemas"
      contains: "type ScreenViewEvent struct"
  key_links:
    - from: "sdk/mobile/causality.go"
      to: "sdk/mobile/bridge.go"
      via: "JSON parsing for all inputs"
      pattern: "parseConfig|parseEvent|parseUser"
    - from: "sdk/mobile/causality.go"
      to: "sdk/mobile/callbacks.go"
      via: "Error callback invocation"
      pattern: "notifyErrorCallbacks"
---

<objective>
Create the Go mobile core package with JSON bridge API that exports gomobile-compatible functions, typed event structs for compile-time safety, and error callbacks for critical failures.

Purpose: This is the foundation for the entire mobile SDK. Due to gomobile type limitations, complex data passes as JSON strings internally, but we provide typed event structs in Go that native wrappers can mirror. Critical errors (auth failures, disk full) trigger callbacks for app-level handling.

Output: `sdk/mobile/` package with exported functions using only string, int, bool, error types, plus typed event structs and error callback system.

**Technical Note:** sebuf generates Go types from proto schemas, but doesn't support Swift/Kotlin generation. The typed event experience for developers comes from:
1. Go core: Typed event structs (generated from proto via sebuf or manually defined)
2. JSON bridge: Gomobile limitation - all complex data serializes to JSON
3. Native wrappers: Swift Codable / Kotlin @Serializable structs that mirror Go types

This honors the user's decision (typed events for developers) while working within gomobile constraints.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-gomobile-sdk/02-CONTEXT.md
@.planning/phases/02-gomobile-sdk/02-RESEARCH.md
@sdk/go/causality.go
@sdk/go/config.go
@proto/causality/v1/events.proto
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Go mobile package structure with JSON bridge and typed events</name>
  <files>
    sdk/mobile/causality.go
    sdk/mobile/config.go
    sdk/mobile/bridge.go
    sdk/mobile/events.go
  </files>
  <action>
Create `sdk/mobile/` package with gomobile-compatible exports:

**sdk/mobile/config.go:**
- Config struct with JSON tags for all fields:
  - APIKey, Endpoint, AppID (required)
  - BatchSize, FlushIntervalMs, MaxQueueSize (optional, int)
  - SessionTimeoutMs, DebugMode (optional)
  - EnableSessionTracking (bool, default true)
  - PersistentDeviceID (bool, default false for privacy-first)
  - OfflineRetentionMs (int, configurable retention for offline events)
  - DataPath (string, platform-specific path for SQLite)
- All fields use gomobile-compatible types (string, int, bool)
- Validation method returns error string (empty on success)

**sdk/mobile/events.go:**
Typed event structs that mirror proto schemas (compile-time safety in Go, native wrappers mirror these):

```go
// Base event fields (injected by SDK, not set by developer)
type EventMetadata struct {
    SessionID      string `json:"session_id,omitempty"`
    DeviceID       string `json:"device_id"`
    UserID         string `json:"user_id,omitempty"`
    Timestamp      string `json:"timestamp"`
    IdempotencyKey string `json:"idempotency_key"`
    AppID          string `json:"app_id"`
}

// ScreenViewEvent - type: "screen_view"
type ScreenViewEvent struct {
    ScreenName     string            `json:"screen_name"`
    ScreenClass    string            `json:"screen_class,omitempty"`
    PreviousScreen string            `json:"previous_screen,omitempty"`
    Properties     map[string]interface{} `json:"properties,omitempty"`
}

// ButtonTapEvent - type: "button_tap"
type ButtonTapEvent struct {
    ButtonName   string            `json:"button_name"`
    ButtonID     string            `json:"button_id,omitempty"`
    ScreenName   string            `json:"screen_name,omitempty"`
    Properties   map[string]interface{} `json:"properties,omitempty"`
}

// PurchaseEvent - type: "purchase_complete"
type PurchaseEvent struct {
    ProductID    string  `json:"product_id"`
    Price        float64 `json:"price"`
    Currency     string  `json:"currency"`
    Quantity     int     `json:"quantity"`
    TransactionID string `json:"transaction_id,omitempty"`
}

// CustomEvent - for events not covered by typed structs
type CustomEvent struct {
    EventType  string                 `json:"event_type"`
    Properties map[string]interface{} `json:"properties,omitempty"`
}

// Event wraps any event type with metadata
type Event struct {
    Type       string          `json:"type"`
    Properties json.RawMessage `json:"properties"` // Serialized typed event
    Metadata   EventMetadata   `json:"metadata,omitempty"` // Injected by SDK
}
```

These typed structs:
1. Provide compile-time validation in Go
2. Define the contract for native wrappers (Swift/Kotlin mirror these)
3. Serialize to JSON for the gomobile bridge

**sdk/mobile/bridge.go:**
- parseConfig(jsonStr string) (*Config, error) - unmarshal and validate
- parseEvent(jsonStr string) (*Event, error) - unmarshal event
- parseUser(jsonStr string) (*UserIdentity, error) - unmarshal user
- UserIdentity struct with: UserID, Traits (map), Aliases (slice)
- serializeEvent(event interface{}) (string, error) - serialize typed events

**sdk/mobile/causality.go:**
- Package-level singleton (initialized SDK instance)
- Init(configJSON string) string - initialize SDK, return error message or ""
- Track(eventJSON string) string - enqueue event, return error or ""
- TrackTyped(eventType string, eventJSON string) string - track typed event (validates type)
- SetUser(userJSON string) string - set user identity, return error or ""
- Reset() string - clear user identity (soft reset)
- ResetAll() string - full reset (clear user + regenerate device ID)
- Flush() string - force flush, return error or ""
- GetDeviceId() string - return current device ID
- GetSessionId() string - return current session ID (or empty)
- GetUserId() string - return current user ID (or empty)
- IsInitialized() bool - check if SDK is ready
- SetDebugMode(enabled bool) - toggle debug logging

All functions must use ONLY gomobile-compatible types in signatures:
- string, int, int32, int64, float32, float64, bool
- NO maps, slices, unsigned ints, or custom interfaces in exports

Use encoding/json from stdlib for all JSON operations.
  </action>
  <verify>
    - `go build ./sdk/mobile/` succeeds
    - No CGO imports detected: `go list -f '{{.CgoFiles}}' ./sdk/mobile/` returns empty
    - All exported functions visible: `go doc ./sdk/mobile/ | grep -E "^func (Init|Track|SetUser|Reset|Flush|GetDeviceId)"`
  </verify>
  <done>
    - Package compiles with pure Go (no CGO)
    - Init accepts JSON config string, returns error string or empty
    - Track accepts JSON event string, returns error string or empty
    - Typed event structs provide compile-time validation
    - No gomobile-incompatible types in exported API
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement error callback system for critical failures</name>
  <files>
    sdk/mobile/errors.go
    sdk/mobile/callbacks.go
  </files>
  <action>
**sdk/mobile/errors.go:**
```go
package mobile

// ErrorSeverity indicates how critical an error is
type ErrorSeverity int

const (
    // SeverityDebug - informational, logged in debug mode only
    SeverityDebug ErrorSeverity = iota
    // SeverityWarning - non-critical, SDK continues operating
    SeverityWarning
    // SeverityCritical - serious issue, app should handle
    SeverityCritical
    // SeverityFatal - SDK cannot operate, requires reinitialization
    SeverityFatal
)

// Error codes for categorization
const (
    ErrCodeNotInitialized  = "NOT_INITIALIZED"
    ErrCodeInvalidConfig   = "INVALID_CONFIG"
    ErrCodeInvalidJSON     = "INVALID_JSON"
    ErrCodeNetworkError    = "NETWORK_ERROR"
    ErrCodeAuthFailed      = "AUTH_FAILED"
    ErrCodeDiskFull        = "DISK_FULL"
    ErrCodeDiskError       = "DISK_ERROR"
    ErrCodeQueueFull       = "QUEUE_FULL"
    ErrCodeServerError     = "SERVER_ERROR"
    ErrCodeRateLimited     = "RATE_LIMITED"
)

// SDKError represents a structured error with severity and code
type SDKError struct {
    Code     string        `json:"code"`
    Message  string        `json:"message"`
    Severity ErrorSeverity `json:"severity"`
}

func (e *SDKError) Error() string {
    return e.Message
}

// Error constructors
func newCriticalError(code, message string) *SDKError {
    return &SDKError{Code: code, Message: message, Severity: SeverityCritical}
}

func newFatalError(code, message string) *SDKError {
    return &SDKError{Code: code, Message: message, Severity: SeverityFatal}
}

// wrapError - returns empty string for nil, error message otherwise
func wrapError(err error) string {
    if err == nil {
        return ""
    }
    return err.Error()
}
```

**sdk/mobile/callbacks.go:**
```go
package mobile

import (
    "sync"
)

// ErrorCallback is invoked when critical errors occur
// Parameters:
//   - code: Error code (e.g., "AUTH_FAILED", "DISK_FULL")
//   - message: Human-readable error message
//   - severity: 0=debug, 1=warning, 2=critical, 3=fatal
//
// This allows the app to:
//   - Show user-facing messages for auth failures
//   - Handle disk full by prompting user to free space
//   - Log to crash reporting services
type ErrorCallback interface {
    OnError(code string, message string, severity int)
}

var (
    errorCallbacksMu sync.RWMutex
    errorCallbacks   []ErrorCallback
)

// RegisterErrorCallback adds a callback for critical error notifications
// Native wrappers call this with platform-specific callback implementations
func RegisterErrorCallback(callback ErrorCallback) {
    errorCallbacksMu.Lock()
    defer errorCallbacksMu.Unlock()
    errorCallbacks = append(errorCallbacks, callback)
}

// UnregisterErrorCallbacks clears all registered callbacks
func UnregisterErrorCallbacks() {
    errorCallbacksMu.Lock()
    defer errorCallbacksMu.Unlock()
    errorCallbacks = nil
}

// notifyErrorCallbacks dispatches error to all registered callbacks
// Only called for Warning+ severity (not Debug)
func notifyErrorCallbacks(err *SDKError) {
    if err == nil || err.Severity < SeverityWarning {
        return
    }

    errorCallbacksMu.RLock()
    callbacks := make([]ErrorCallback, len(errorCallbacks))
    copy(callbacks, errorCallbacks)
    errorCallbacksMu.RUnlock()

    for _, cb := range callbacks {
        // Don't block on callbacks - fire and forget
        go cb.OnError(err.Code, err.Message, int(err.Severity))
    }
}

// logError logs errors based on severity and debug mode
func logError(err *SDKError, debugMode bool) {
    if err == nil {
        return
    }

    // Debug severity only logged in debug mode
    if err.Severity == SeverityDebug && !debugMode {
        return
    }

    // Log the error (platform logging happens in native wrappers)
    // This is for Go-side logging
    switch err.Severity {
    case SeverityDebug:
        debugLog("DEBUG: %s - %s", err.Code, err.Message)
    case SeverityWarning:
        debugLog("WARN: %s - %s", err.Code, err.Message)
    case SeverityCritical, SeverityFatal:
        debugLog("ERROR: %s - %s", err.Code, err.Message)
        notifyErrorCallbacks(err)
    }
}

// debugLog is a simple logging helper (conditionally compiled out in release)
func debugLog(format string, args ...interface{}) {
    // Implementation uses platform-specific logging
    // For now, just print (native wrappers can override)
}
```

Update causality.go to use error callbacks:
- On auth failure (401 from server): notifyErrorCallbacks(newCriticalError(ErrCodeAuthFailed, "..."))
- On disk full: notifyErrorCallbacks(newCriticalError(ErrCodeDiskFull, "..."))
- On server 5xx: notifyErrorCallbacks(newCriticalError(ErrCodeServerError, "..."))
- On rate limit (429): notifyErrorCallbacks(newCriticalError(ErrCodeRateLimited, "..."))
  </action>
  <verify>
    - `go build ./sdk/mobile/` compiles
    - ErrorCallback interface is gomobile-compatible (single method with basic types)
    - `go doc ./sdk/mobile/ | grep RegisterErrorCallback`
  </verify>
  <done>
    - ErrorSeverity enum with Debug, Warning, Critical, Fatal levels
    - Error codes for all critical failure types
    - ErrorCallback interface for app-level error handling
    - RegisterErrorCallback allows native wrappers to register handlers
    - Critical errors (auth, disk, network) trigger callbacks
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for JSON bridge and callbacks</name>
  <files>
    sdk/mobile/bridge_test.go
    sdk/mobile/config_test.go
    sdk/mobile/callbacks_test.go
  </files>
  <action>
**sdk/mobile/config_test.go:**
- TestConfigParsing_ValidConfig - all fields populated
- TestConfigParsing_MinimalConfig - only required fields
- TestConfigParsing_Defaults - verify defaults applied
- TestConfigValidation_MissingAPIKey - returns error
- TestConfigValidation_MissingEndpoint - returns error
- TestConfigValidation_MissingAppID - returns error
- TestConfigValidation_InvalidEndpoint - returns error for malformed URL

**sdk/mobile/bridge_test.go:**
- TestParseEvent_ValidEvent - full event with properties
- TestParseEvent_TypedScreenView - screen view event
- TestParseEvent_TypedPurchase - purchase event with all fields
- TestParseEvent_MinimalEvent - type only
- TestParseEvent_InvalidJSON - returns error
- TestParseUser_ValidUser - user ID and traits
- TestParseUser_WithAliases - aliases array
- TestParseUser_InvalidJSON - returns error
- TestSerializeEvent_TypedEvent - serialize typed event to JSON

**sdk/mobile/callbacks_test.go:**
- TestRegisterErrorCallback_ReceivesCritical - callback invoked for critical
- TestRegisterErrorCallback_ReceivesFatal - callback invoked for fatal
- TestRegisterErrorCallback_IgnoresDebug - callback not invoked for debug
- TestRegisterErrorCallback_IgnoresWarningByDefault - (warning goes to logs)
- TestMultipleCallbacks_AllNotified - multiple callbacks receive same error
- TestUnregisterCallbacks_ClearsAll - no callbacks after unregister
- TestCallbackDoesNotBlock - callbacks run async, don't block caller

Use table-driven tests for validation cases.
Verify error messages are descriptive and actionable.
Use mock ErrorCallback implementation for testing.
  </action>
  <verify>
    - `go test ./sdk/mobile/... -v` passes all tests
    - Test coverage: `go test ./sdk/mobile/... -cover` shows >= 80% for bridge.go, config.go, callbacks.go
  </verify>
  <done>
    - All JSON parsing edge cases covered
    - Typed event serialization works
    - Validation errors are descriptive
    - Error callbacks tested for all severity levels
    - Tests pass with >= 80% coverage
  </done>
</task>

</tasks>

<verification>
- Package compiles: `go build ./sdk/mobile/`
- No CGO: `go list -f '{{.CgoFiles}}' ./sdk/mobile/` returns `[]`
- Tests pass: `go test ./sdk/mobile/... -v`
- Exported API check: `go doc ./sdk/mobile/`
</verification>

<success_criteria>
- sdk/mobile package exists with Init, Track, SetUser, Reset, Flush, GetDeviceId exports
- All exported functions use only gomobile-compatible types (string, int, bool)
- Typed event structs (ScreenViewEvent, PurchaseEvent, etc.) provide compile-time safety
- ErrorCallback interface allows native wrappers to handle critical errors
- JSON bridge correctly parses config, events, and user data
- Unit tests pass with >= 80% coverage on bridge/config/callbacks
- No CGO dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/02-gomobile-sdk/02-01-SUMMARY.md`
</output>
