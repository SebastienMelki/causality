---
phase: 02-gomobile-sdk
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sdk/mobile/causality.go
  - sdk/mobile/config.go
  - sdk/mobile/bridge.go
  - sdk/mobile/errors.go
autonomous: true

must_haves:
  truths:
    - "Go mobile package compiles without CGO"
    - "JSON config can initialize SDK state"
    - "Exported functions use only gomobile-compatible types"
  artifacts:
    - path: "sdk/mobile/causality.go"
      provides: "Init, Track, SetUser, Reset, Flush, GetDeviceId exports"
      exports: ["Init", "Track", "SetUser", "Reset", "Flush", "GetDeviceId"]
    - path: "sdk/mobile/config.go"
      provides: "Configuration struct with JSON tags"
      contains: "type Config struct"
    - path: "sdk/mobile/bridge.go"
      provides: "JSON marshal/unmarshal helpers"
      exports: ["parseConfig", "parseEvent", "parseUser"]
    - path: "sdk/mobile/errors.go"
      provides: "Error constants and error response helpers"
  key_links:
    - from: "sdk/mobile/causality.go"
      to: "sdk/mobile/bridge.go"
      via: "JSON parsing for all inputs"
      pattern: "parseConfig|parseEvent|parseUser"
---

<objective>
Create the Go mobile core package with JSON bridge API that exports gomobile-compatible functions.

Purpose: This is the foundation for the entire mobile SDK. All complex data passes as JSON strings to work around gomobile type limitations. The exported functions (Init, Track, SetUser, Reset, Flush, GetDeviceId) form the bridge between native platforms and Go.

Output: `sdk/mobile/` package with exported functions using only string, int, bool, error types.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-gomobile-sdk/02-CONTEXT.md
@.planning/phases/02-gomobile-sdk/02-RESEARCH.md
@sdk/go/causality.go
@sdk/go/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Go mobile package structure with JSON bridge</name>
  <files>
    sdk/mobile/causality.go
    sdk/mobile/config.go
    sdk/mobile/bridge.go
    sdk/mobile/errors.go
  </files>
  <action>
Create `sdk/mobile/` package with gomobile-compatible exports:

**sdk/mobile/config.go:**
- Config struct with JSON tags for all fields:
  - APIKey, Endpoint, AppID (required)
  - BatchSize, FlushIntervalMs, MaxQueueSize (optional, int)
  - SessionTimeoutMs, DebugMode (optional)
  - EnableSessionTracking (bool, default true)
  - PersistentDeviceID (bool, default false for privacy-first)
- All fields use gomobile-compatible types (string, int, bool)
- Validation method returns error string (empty on success)

**sdk/mobile/bridge.go:**
- parseConfig(jsonStr string) (*Config, error) - unmarshal and validate
- parseEvent(jsonStr string) (*Event, error) - unmarshal event
- parseUser(jsonStr string) (*UserIdentity, error) - unmarshal user
- Event struct with: Type, Properties (JSON string), Timestamp, IdempotencyKey
- UserIdentity struct with: UserID, Traits (JSON string), Aliases (JSON string)

**sdk/mobile/errors.go:**
- Error constants: ErrNotInitialized, ErrInvalidConfig, ErrInvalidJSON
- wrapError(err error) string - returns empty string for nil, error message otherwise
- All exported functions return string (empty=success, non-empty=error message)

**sdk/mobile/causality.go:**
- Package-level singleton (initialized SDK instance)
- Init(configJSON string) string - initialize SDK, return error message or ""
- Track(eventJSON string) string - enqueue event, return error or ""
- SetUser(userJSON string) string - set user identity, return error or ""
- Reset() string - clear user identity (soft reset)
- ResetAll() string - full reset (clear user + regenerate device ID)
- Flush() string - force flush, return error or ""
- GetDeviceId() string - return current device ID
- IsInitialized() bool - check if SDK is ready
- SetDebugMode(enabled bool) - toggle debug logging

All functions must use ONLY gomobile-compatible types in signatures:
- string, int, int32, int64, float32, float64, bool
- NO maps, slices, unsigned ints, or custom interfaces in exports

Use encoding/json from stdlib for all JSON operations.
  </action>
  <verify>
    - `go build ./sdk/mobile/` succeeds
    - No CGO imports detected: `go list -f '{{.CgoFiles}}' ./sdk/mobile/` returns empty
    - All exported functions visible: `go doc ./sdk/mobile/ | grep -E "^func (Init|Track|SetUser|Reset|Flush|GetDeviceId)"`
  </verify>
  <done>
    - Package compiles with pure Go (no CGO)
    - Init accepts JSON config string, returns error string or empty
    - Track accepts JSON event string, returns error string or empty
    - SetUser, Reset, Flush, GetDeviceId all use string returns
    - No gomobile-incompatible types in exported API
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for JSON bridge parsing</name>
  <files>
    sdk/mobile/bridge_test.go
    sdk/mobile/config_test.go
  </files>
  <action>
Create comprehensive unit tests for the JSON bridge:

**sdk/mobile/config_test.go:**
- TestConfigParsing_ValidConfig - all fields populated
- TestConfigParsing_MinimalConfig - only required fields
- TestConfigParsing_Defaults - verify defaults applied
- TestConfigValidation_MissingAPIKey - returns error
- TestConfigValidation_MissingEndpoint - returns error
- TestConfigValidation_MissingAppID - returns error
- TestConfigValidation_InvalidEndpoint - returns error for malformed URL

**sdk/mobile/bridge_test.go:**
- TestParseEvent_ValidEvent - full event with properties
- TestParseEvent_MinimalEvent - type only
- TestParseEvent_InvalidJSON - returns error
- TestParseUser_ValidUser - user ID and traits
- TestParseUser_WithAliases - aliases array as JSON string
- TestParseUser_InvalidJSON - returns error

Use table-driven tests for validation cases.
Verify error messages are descriptive and actionable.
  </action>
  <verify>
    - `go test ./sdk/mobile/... -v` passes all tests
    - Test coverage: `go test ./sdk/mobile/... -cover` shows >= 80% for bridge.go and config.go
  </verify>
  <done>
    - All JSON parsing edge cases covered
    - Validation errors are descriptive
    - Tests pass with >= 80% coverage on bridge and config
  </done>
</task>

</tasks>

<verification>
- Package compiles: `go build ./sdk/mobile/`
- No CGO: `go list -f '{{.CgoFiles}}' ./sdk/mobile/` returns `[]`
- Tests pass: `go test ./sdk/mobile/... -v`
- Exported API check: `go doc ./sdk/mobile/`
</verification>

<success_criteria>
- sdk/mobile package exists with Init, Track, SetUser, Reset, Flush, GetDeviceId exports
- All exported functions use only gomobile-compatible types (string, int, bool)
- JSON bridge correctly parses config, events, and user data
- Unit tests pass with >= 80% coverage on bridge/config
- No CGO dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/02-gomobile-sdk/02-01-SUMMARY.md`
</output>
