---
phase: 02-gomobile-sdk
plan: 05
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - sdk/mobile/internal/batch/batcher.go
  - sdk/mobile/internal/batch/flush.go
  - sdk/mobile/internal/transport/client.go
  - sdk/mobile/internal/transport/retry.go
  - sdk/mobile/internal/batch/batcher_test.go
  - sdk/mobile/internal/transport/client_test.go
  - sdk/mobile/internal/transport/retry_test.go
autonomous: true

must_haves:
  truths:
    - "Events batch by count AND time (whichever first)"
    - "Batches are sent via HTTP with retry on failure"
    - "Failed events remain in queue for retry"
    - "Exponential backoff with jitter prevents thundering herd"
  artifacts:
    - path: "sdk/mobile/internal/batch/batcher.go"
      provides: "Event batching with size and time triggers"
      exports: ["NewBatcher", "Add", "Flush", "Stop"]
    - path: "sdk/mobile/internal/transport/client.go"
      provides: "HTTP client for sending batches"
      exports: ["NewClient", "SendBatch"]
    - path: "sdk/mobile/internal/transport/retry.go"
      provides: "Retry strategies with exponential backoff"
      exports: ["RetryStrategy", "ExponentialBackoff", "DefaultRetry"]
  key_links:
    - from: "sdk/mobile/internal/batch/batcher.go"
      to: "sdk/mobile/internal/storage/queue.go"
      via: "Queue for persistence"
      pattern: "storage\\.Queue"
    - from: "sdk/mobile/internal/batch/batcher.go"
      to: "sdk/mobile/internal/transport/client.go"
      via: "HTTP transport for sending"
      pattern: "transport\\.Client"
---

<objective>
Implement event batching with dual triggers (count + time) and HTTP transport with retry logic.

Purpose: Batching reduces network overhead and battery usage. Events are persisted to SQLite first (02-02), then batched for sending. Retry with exponential backoff handles transient failures without overwhelming the server.

Output: `sdk/mobile/internal/batch/` and `sdk/mobile/internal/transport/` packages.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-gomobile-sdk/02-CONTEXT.md
@.planning/phases/02-gomobile-sdk/02-RESEARCH.md
@.planning/phases/02-gomobile-sdk/02-02-SUMMARY.md
@sdk/go/batch.go
@sdk/go/transport.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement HTTP transport with retry strategies</name>
  <files>
    sdk/mobile/internal/transport/client.go
    sdk/mobile/internal/transport/retry.go
  </files>
  <action>
**sdk/mobile/internal/transport/retry.go:**

RetryStrategy interface:
- NextDelay(attempt int) time.Duration (return 0 for no more retries)
- MaxAttempts() int

ExponentialBackoff struct:
- BaseDelay time.Duration
- MaxDelay time.Duration
- MaxRetries int
- Jitter float64 (0.0 to 1.0)

func (e *ExponentialBackoff) NextDelay(attempt int) time.Duration:
- If attempt >= MaxRetries, return 0
- delay = BaseDelay * 2^attempt
- Cap at MaxDelay
- Apply jitter: delay += delay * Jitter * (rand.Float64()*2 - 1)
- Return delay

func (e *ExponentialBackoff) MaxAttempts() int:
- Return MaxRetries

DefaultRetry = &ExponentialBackoff{
  BaseDelay: 1 * time.Second,
  MaxDelay: 5 * time.Minute,
  MaxRetries: 10,
  Jitter: 0.2,
}

LinearBackoff struct (alternative):
- Delay time.Duration
- MaxRetries int
- Jitter float64

**sdk/mobile/internal/transport/client.go:**

Client struct:
- httpClient *http.Client
- endpoint string
- apiKey string
- retry RetryStrategy
- userAgent string

NewClient(endpoint, apiKey string, timeout time.Duration, retry RetryStrategy) *Client:
- Create http.Client with timeout
- Set user agent: "CausalitySDK/1.0.0 Go"

SendBatch(ctx context.Context, events []QueuedEvent) error:
- Build request body as JSON array of events
- POST to {endpoint}/v1/events/batch
- Headers: X-API-Key, Content-Type: application/json, User-Agent
- Retry loop:
  - Execute request
  - On 2xx: return nil (success)
  - On 4xx (except 429): return error (don't retry, bad request)
  - On 429 or 5xx: check Retry-After header, use retry strategy delay
  - Sleep with delay
  - Continue until max attempts or context canceled
- Return last error if all retries exhausted

isRetryableStatus(code int) bool:
- Return true for 429, 500, 502, 503, 504
- Return false for other codes

Extract response body on error for debugging.
Use context for cancellation support.
  </action>
  <verify>
    - `go build ./sdk/mobile/internal/transport/` compiles
    - No external HTTP dependencies (use stdlib net/http)
  </verify>
  <done>
    - HTTP client sends batches with proper headers
    - Retry on 5xx and 429 with exponential backoff
    - No retry on 4xx (except 429)
    - Jitter prevents synchronized retries
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement batcher with dual triggers and tests</name>
  <files>
    sdk/mobile/internal/batch/batcher.go
    sdk/mobile/internal/batch/flush.go
    sdk/mobile/internal/batch/batcher_test.go
    sdk/mobile/internal/transport/client_test.go
    sdk/mobile/internal/transport/retry_test.go
  </files>
  <action>
**sdk/mobile/internal/batch/batcher.go:**

Batcher struct:
- queue *storage.Queue
- transport *transport.Client
- batchSize int
- flushInterval time.Duration
- minBatchSize int (prevent 1-event batches, default 5)
- minFlushInterval time.Duration (prevent rapid fire, default 5s)
- mu sync.Mutex
- pendingCount int (track events added since last flush)
- lastFlush time.Time
- stopCh chan struct{}
- doneCh chan struct{}

NewBatcher(queue, transport, batchSize, flushInterval, minBatchSize, minFlushInterval) *Batcher:
- Apply minimums: max(batchSize, minBatchSize), max(flushInterval, minFlushInterval)

Add(eventJSON, idempotencyKey string) error:
- Enqueue to storage
- Increment pendingCount
- If pendingCount >= batchSize AND time.Since(lastFlush) >= minFlushInterval:
  - Trigger async flush
- Return nil (non-blocking)

Flush(ctx context.Context) error:
- Lock
- Dequeue batch from storage
- If empty, return nil
- Send via transport
- On success: delete from queue
- On failure: mark for retry (increment retry_count)
- Update lastFlush time
- Reset pendingCount
- Unlock

**sdk/mobile/internal/batch/flush.go:**

StartFlushLoop(ctx context.Context) (background flush goroutine):
- Ticker at flushInterval
- On tick: call Flush
- On ctx.Done(): exit and close doneCh

Stop():
- Close stopCh
- Wait for doneCh

**Tests:**

**sdk/mobile/internal/transport/retry_test.go:**
- TestExponentialBackoff_DelaysIncrease
- TestExponentialBackoff_CapsAtMaxDelay
- TestExponentialBackoff_StopsAfterMaxRetries
- TestExponentialBackoff_JitterVariation (run 100 times, verify variance)

**sdk/mobile/internal/transport/client_test.go:**
- TestSendBatch_Success - mock 200 response
- TestSendBatch_Retry5xx - mock 500, then 200
- TestSendBatch_Retry429 - mock 429 with Retry-After
- TestSendBatch_NoRetry4xx - mock 400, verify immediate error
- TestSendBatch_AllRetriesExhausted - mock 500 always, verify error after max
- Use httptest.Server for mocking

**sdk/mobile/internal/batch/batcher_test.go:**
- TestAdd_EnqueuesEvent
- TestAdd_TriggersFlushAtBatchSize
- TestAdd_RespectsMinFlushInterval
- TestFlush_SendsAndDeletes
- TestFlush_KeepsFailedEvents
- TestFlushLoop_PeriodicFlush
- TestStop_WaitsForCompletion

Use mock queue and transport for unit tests.
  </action>
  <verify>
    - `go test ./sdk/mobile/internal/batch/... -v -race` passes
    - `go test ./sdk/mobile/internal/transport/... -v -race` passes
    - Combined coverage >= 80%
  </verify>
  <done>
    - Batcher triggers on count AND time (whichever first)
    - Minimum thresholds prevent abuse
    - Failed events stay in queue for retry
    - Exponential backoff with jitter works
    - Tests pass with >= 80% coverage, no data races
  </done>
</task>

</tasks>

<verification>
- Build: `go build ./sdk/mobile/internal/batch/` and `go build ./sdk/mobile/internal/transport/`
- Tests: `go test ./sdk/mobile/internal/batch/... ./sdk/mobile/internal/transport/... -v -race`
- Coverage: `go test ./sdk/mobile/internal/batch/... ./sdk/mobile/internal/transport/... -cover`
</verification>

<success_criteria>
- Batching triggers on event count OR time interval (whichever first)
- Minimum thresholds prevent 1-event batches and rapid fire
- HTTP transport retries on 5xx/429 with exponential backoff
- No retry on 4xx (except 429)
- Jitter prevents thundering herd
- Failed events remain in queue for later retry
- Tests pass with >= 80% coverage, no data races
</success_criteria>

<output>
After completion, create `.planning/phases/02-gomobile-sdk/02-05-SUMMARY.md`
</output>
