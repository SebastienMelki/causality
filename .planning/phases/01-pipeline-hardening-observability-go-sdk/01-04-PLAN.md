---
phase: 01-pipeline-hardening-observability-go-sdk
plan: 04
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - internal/dedup/module.go
  - internal/dedup/ports.go
  - internal/dedup/adapters.go
  - internal/dedup/internal/domain/bloom.go
  - internal/dedup/internal/service/dedup_service.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "Events with duplicate idempotency_key are silently dropped"
    - "Bloom filter uses sliding window with periodic rotation"
    - "Dedup window is configurable (default: 10 minutes)"
    - "Dropped duplicates are counted via DedupDropped metric"
    - "Non-duplicate events pass through unchanged"
  artifacts:
    - path: "internal/dedup/module.go"
      provides: "Dedup module facade"
      exports: ["Module", "New"]
    - path: "internal/dedup/ports.go"
      provides: "Deduplicator interface"
      contains: "Deduplicator"
    - path: "internal/dedup/adapters.go"
      provides: "HTTP middleware adapter for dedup"
      exports: ["DeduplicateMiddleware"]
    - path: "internal/dedup/internal/domain/bloom.go"
      provides: "Sliding window bloom filter"
      contains: "BloomFilterSet"
    - path: "internal/dedup/internal/service/dedup_service.go"
      provides: "Dedup service with rotation"
      contains: "IsDuplicate"
  key_links:
    - from: "internal/dedup/internal/domain/bloom.go"
      to: "github.com/bits-and-blooms/bloom/v3"
      via: "bloom.NewWithEstimates"
      pattern: "bloom\\.NewWithEstimates"
    - from: "internal/dedup/internal/service/dedup_service.go"
      to: "internal/dedup/internal/domain/bloom.go"
      via: "service uses BloomFilterSet.IsDuplicate"
      pattern: "IsDuplicate"
---

<objective>
Create the dedup module with a sliding window bloom filter for server-side event deduplication using idempotency keys.

Purpose: R1.2 requires duplicate events to be silently dropped. The bloom filter provides memory-efficient dedup without external infrastructure. The sliding window (two filters with rotation) ensures a bounded time window.
Output: `internal/dedup/` module with bloom filter domain, dedup service, and HTTP middleware adapter.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-pipeline-hardening-observability-go-sdk/01-RESEARCH.md
@.planning/phases/01-pipeline-hardening-observability-go-sdk/01-01-SUMMARY.md
@internal/gateway/service.go
@go.mod
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bloom filter domain and dedup service</name>
  <files>
    internal/dedup/internal/domain/bloom.go
    internal/dedup/internal/service/dedup_service.go
    internal/dedup/ports.go
    go.mod
    go.sum
  </files>
  <action>
    Install bloom filter dependency:
    ```
    go get github.com/bits-and-blooms/bloom/v3@latest
    ```

    **Create `internal/dedup/ports.go`:**
    - `Deduplicator` interface:
      ```go
      type Deduplicator interface {
          IsDuplicate(key string) bool
          Start(ctx context.Context)
          Stop()
      }
      ```

    **Create `internal/dedup/internal/domain/bloom.go`:**
    - `BloomFilterSet` struct:
      - `current *bloom.BloomFilter`
      - `previous *bloom.BloomFilter`
      - `mu sync.RWMutex`
      - `window time.Duration`
      - `capacity uint`
      - `fpRate float64`
    - `NewBloomFilterSet(window time.Duration, capacity uint, fpRate float64) *BloomFilterSet`
      - Creates two bloom filters via `bloom.NewWithEstimates(capacity, fpRate)`
      - capacity default: 1_000_000 (expected events per window)
      - fpRate default: 0.0001 (0.01% false positive rate — low because FP = data loss)
    - `IsDuplicate(key string) bool`:
      - RLock, test key in current AND previous
      - If found in either: RUnlock, return true
      - RUnlock, Lock, add to current, Unlock, return false
      - Thread-safe for concurrent use
    - `Rotate()`:
      - Lock, swap `previous = current`, create fresh `current`, Unlock
      - Called every `window/2` to create sliding overlap

    **Create `internal/dedup/internal/service/dedup_service.go`:**
    - `DedupService` struct:
      - `filter *domain.BloomFilterSet`
      - `metrics *observability.Metrics` (optional, can be nil)
      - `logger *slog.Logger`
      - `stopCh chan struct{}`
      - `doneCh chan struct{}`
    - `NewDedupService(window time.Duration, capacity uint, fpRate float64, metrics *observability.Metrics, logger *slog.Logger) *DedupService`
    - `IsDuplicate(key string) bool`:
      - If key is empty: return false (events without idempotency key pass through)
      - Call `filter.IsDuplicate(key)`
      - If duplicate: increment `metrics.DedupDropped` counter (if metrics non-nil), return true
      - Return false
    - `Start(ctx context.Context)`:
      - Launch goroutine that rotates the bloom filter every `window/2`
      - Uses ticker, listens for ctx.Done() or stopCh
    - `Stop()`: close stopCh, wait for doneCh
  </action>
  <verify>
    - `go build ./internal/dedup/...` compiles
    - `go vet ./internal/dedup/...` passes
    - `grep "bloom.NewWithEstimates" internal/dedup/internal/domain/bloom.go` confirms bloom usage
    - `grep "IsDuplicate" internal/dedup/internal/service/dedup_service.go` confirms service method
  </verify>
  <done>
    Bloom filter domain with sliding window rotation and dedup service with metrics exist. Empty idempotency keys pass through. Duplicates are silently dropped with metric increment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dedup module facade and middleware adapter</name>
  <files>
    internal/dedup/module.go
    internal/dedup/adapters.go
  </files>
  <action>
    **Create `internal/dedup/module.go`:**
    - `Config` struct:
      - `Window time.Duration` (env: `DEDUP_WINDOW`, default: 10*time.Minute)
      - `Capacity uint` (env: `DEDUP_CAPACITY`, default: 1_000_000)
      - `FPRate float64` (env: `DEDUP_FP_RATE`, default: 0.0001)
    - `Module` struct holding `*service.DedupService`
    - `New(cfg Config, metrics *observability.Metrics, logger *slog.Logger) *Module`
      - Creates DedupService with config values
      - Returns module
    - `Start(ctx context.Context)` — starts the rotation goroutine
    - `Stop()` — stops the rotation goroutine
    - `IsDuplicate(key string) bool` — delegates to service

    **Create `internal/dedup/adapters.go`:**
    - This is NOT an HTTP middleware (dedup happens at the event service level, not HTTP level).
    - Instead, provide a function adapter that the gateway EventService can call:
    - `CheckDuplicate(idempotencyKey string) bool` — returns true if event should be dropped
    - The actual integration into the EventService happens in the gateway integration plan (01-06).
    - Also provide a NATS-level adapter for consumer-side dedup (warehouse sink and reaction engine can dedup on consume):
    - `FilterEvents(events []*pb.EventEnvelope) []*pb.EventEnvelope` — filters out events with duplicate idempotency_key, returns only non-duplicates

    Note: Server-side dedup at the HTTP gateway level catches duplicates at ingestion time. Consumer-side dedup is a defense-in-depth measure for events that made it through (e.g., during dedup module restart).
  </action>
  <verify>
    - `go build ./internal/dedup/...` compiles
    - `go vet ./internal/dedup/...` passes
    - Module has Start, Stop, IsDuplicate, and CheckDuplicate methods
  </verify>
  <done>
    Dedup module has clean facade, configurable window/capacity/FP rate, and adapter functions for both HTTP-level and consumer-level dedup. Ready for integration into gateway and consumers.
  </done>
</task>

</tasks>

<verification>
- `go build ./internal/dedup/...` compiles
- All files exist: module.go, ports.go, adapters.go, internal/domain/bloom.go, internal/service/dedup_service.go
- `grep "bits-and-blooms/bloom" go.mod` shows dependency added
- Bloom filter uses sliding window (two filters + rotation)
- Empty idempotency keys are not treated as duplicates
</verification>

<success_criteria>
- Bloom filter dedup with sliding window and periodic rotation
- Configurable dedup window (default: 10 minutes)
- Configurable capacity and false positive rate
- Dropped duplicates counted via DedupDropped metric
- Empty idempotency keys pass through (backwards compatible)
- Thread-safe for concurrent use
- Module follows hexagonal pattern with ports and adapters
</success_criteria>

<output>
After completion, create `.planning/phases/01-pipeline-hardening-observability-go-sdk/01-04-SUMMARY.md`
</output>
