---
phase: 01-pipeline-hardening-observability-go-sdk
plan: 10
type: tdd
wave: 5
depends_on: ["01-02", "01-03", "01-04", "01-06", "01-07", "01-08", "01-09"]
files_modified:
  - internal/auth/internal/domain/apikey_test.go
  - internal/auth/internal/service/key_service_test.go
  - internal/dedup/internal/domain/bloom_test.go
  - internal/dedup/internal/service/dedup_service_test.go
  - internal/warehouse/consumer_test.go
  - internal/gateway/service_test.go
  - internal/gateway/middleware_test.go
  - internal/compaction/internal/service/compaction_service_test.go
  - sdk/go/causality_test.go
  - sdk/go/transport_test.go
autonomous: true

must_haves:
  truths:
    - "Auth domain tests: key generation returns 64-char hex, hash is deterministic, format validation works"
    - "Auth service tests: valid key returns APIKey, revoked key returns nil, unknown hash returns nil"
    - "Dedup bloom tests: first occurrence not duplicate, second occurrence is duplicate, rotation creates fresh filter"
    - "Dedup service tests: empty key not duplicate, duplicate key counted, metrics incremented"
    - "Gateway validation tests: missing app_id returns error, missing event_type returns error"
    - "Gateway middleware tests: missing X-API-Key returns 401, body over limit returns 413"
    - "Warehouse consumer tests: ACK called after flush, NAK called on write error, Term called on unmarshal error"
    - "SDK tests: Track enqueues event, Flush sends batch, Close flushes and stops"
    - "Test coverage >= 70% across all new modules"
  artifacts:
    - path: "internal/auth/internal/domain/apikey_test.go"
      provides: "Auth domain unit tests"
      contains: "TestGenerateKey"
    - path: "internal/dedup/internal/domain/bloom_test.go"
      provides: "Bloom filter unit tests"
      contains: "TestIsDuplicate"
    - path: "internal/warehouse/consumer_test.go"
      provides: "Consumer ACK/NAK/Term tests"
      contains: "TestFlush_ACKAfterWrite"
    - path: "internal/gateway/service_test.go"
      provides: "Event validation tests"
      contains: "TestValidation"
    - path: "sdk/go/causality_test.go"
      provides: "SDK client tests"
      contains: "TestTrack"
  key_links:
    - from: "internal/auth/internal/domain/apikey_test.go"
      to: "internal/auth/internal/domain/apikey.go"
      via: "tests GenerateKey and HashKey"
      pattern: "GenerateKey"
    - from: "internal/warehouse/consumer_test.go"
      to: "internal/warehouse/consumer.go"
      via: "tests ACK-after-write with mock messages"
      pattern: "Ack\\(\\)"
---

<objective>
Achieve >= 70% test coverage across all Phase 1 modules by writing unit tests for business logic: auth domain/service, bloom filter dedup, consumer ACK/NAK behavior, event validation, gateway middleware, compaction logic, and Go SDK.

Purpose: R1.10 requires >= 70% test coverage. These tests validate the critical business logic added in this phase and catch regressions. TDD approach: write tests that define expected behavior, then verify existing code passes.
Output: Test files for all Phase 1 modules with comprehensive unit tests.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-pipeline-hardening-observability-go-sdk/01-RESEARCH.md
@.planning/phases/01-pipeline-hardening-observability-go-sdk/01-02-SUMMARY.md
@.planning/phases/01-pipeline-hardening-observability-go-sdk/01-03-SUMMARY.md
@.planning/phases/01-pipeline-hardening-observability-go-sdk/01-04-SUMMARY.md
@.planning/phases/01-pipeline-hardening-observability-go-sdk/01-06-SUMMARY.md
@.planning/phases/01-pipeline-hardening-observability-go-sdk/01-07-SUMMARY.md
@.planning/phases/01-pipeline-hardening-observability-go-sdk/01-09-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write unit tests for auth and dedup modules</name>
  <files>
    internal/auth/internal/domain/apikey_test.go
    internal/auth/internal/service/key_service_test.go
    internal/dedup/internal/domain/bloom_test.go
    internal/dedup/internal/service/dedup_service_test.go
  </files>
  <action>
    **`internal/auth/internal/domain/apikey_test.go`:**
    - `TestGenerateKey_ReturnsValidKeyAndHash`: key is 64 hex chars, hash is 64 hex chars, key != hash
    - `TestGenerateKey_UniquenessAcrossCalls`: two calls return different keys
    - `TestHashKey_Deterministic`: same input returns same hash
    - `TestHashKey_DifferentInputsDifferentHashes`: different keys produce different hashes
    - `TestValidateKeyFormat_ValidKey`: 64 hex chars returns true
    - `TestValidateKeyFormat_InvalidKey`: wrong length, non-hex chars return false

    **`internal/auth/internal/service/key_service_test.go`:**
    - Create mock `KeyStore` implementing the interface (use a map)
    - `TestValidateKey_ValidKey`: store has key, service returns it
    - `TestValidateKey_RevokedKey`: store has revoked key, service returns nil
    - `TestValidateKey_UnknownHash`: store returns nil, service returns nil
    - `TestCreateKey_Success`: service creates key, store.Create called, plaintext returned
    - `TestRevokeKey_Success`: service revokes, store.Revoke called
    - `TestListKeys_ByAppID`: store returns keys for app_id

    **`internal/dedup/internal/domain/bloom_test.go`:**
    - `TestBloomFilterSet_FirstOccurrence`: new key returns false (not duplicate)
    - `TestBloomFilterSet_SecondOccurrence`: same key returns true (duplicate)
    - `TestBloomFilterSet_DifferentKeys`: different keys both return false
    - `TestBloomFilterSet_Rotate_PreservesCurrentInPrevious`: after rotation, key added before rotation is still found (in previous filter)
    - `TestBloomFilterSet_DoubleRotate_ExpiresPrevious`: after two rotations, key from before first rotation is gone
    - `TestBloomFilterSet_ConcurrentAccess`: goroutines calling IsDuplicate concurrently don't panic (race detector test)

    **`internal/dedup/internal/service/dedup_service_test.go`:**
    - `TestDedupService_EmptyKeyNotDuplicate`: empty string returns false
    - `TestDedupService_FirstEventNotDuplicate`: new key returns false
    - `TestDedupService_DuplicateEventDetected`: same key twice returns true on second call
    - `TestDedupService_MetricsIncremented`: mock metrics, verify DedupDropped incremented on duplicate

    Run with race detector: `go test -race ./internal/auth/... ./internal/dedup/...`
  </action>
  <verify>
    - `go test ./internal/auth/...` passes
    - `go test ./internal/dedup/...` passes
    - `go test -race ./internal/auth/... ./internal/dedup/...` passes (no races)
    - `go test -cover ./internal/auth/internal/domain/` shows >= 80% coverage
    - `go test -cover ./internal/dedup/internal/domain/` shows >= 80% coverage
  </verify>
  <done>
    Auth domain and service have comprehensive unit tests with mock store. Bloom filter has tests for dedup, rotation, and concurrent safety. All tests pass with race detector.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write unit tests for gateway, warehouse consumer, compaction, and Go SDK</name>
  <files>
    internal/gateway/service_test.go
    internal/gateway/middleware_test.go
    internal/warehouse/consumer_test.go
    internal/compaction/internal/service/compaction_service_test.go
    sdk/go/causality_test.go
    sdk/go/transport_test.go
  </files>
  <action>
    **`internal/gateway/service_test.go`** (extend existing):
    - `TestIngestEvent_MissingAppID_ReturnsError`: event without app_id is rejected
    - `TestIngestEvent_MissingEventType_ReturnsError`: event without event_type is rejected
    - `TestIngestEvent_DuplicateDropped`: dedup returns true, event not published
    - `TestIngestEvent_IdempotencyKeyGenerated`: event without idempotency_key gets one assigned
    - `TestIngestEventBatch_MixedValidInvalid`: batch with some invalid events, valid ones accepted, invalid rejected

    **`internal/gateway/middleware_test.go`:**
    - `TestPerKeyRateLimit_AllowsUnderLimit`: requests under rate pass through
    - `TestPerKeyRateLimit_BlocksOverLimit`: requests over rate return 429
    - `TestPerKeyRateLimit_DifferentKeysIndependent`: different app_ids have separate limits
    - `TestBodySizeLimit_UnderLimit`: small body passes
    - `TestBodySizeLimit_OverLimit`: large body returns error
    - Use `httptest.NewRecorder` and `httptest.NewRequest`

    **`internal/warehouse/consumer_test.go`:**
    - Create mock `jetstream.Msg` implementation that records Ack/Nak/Term calls
    - `TestFlush_ACKAfterWrite`: batch of tracked events, flush succeeds, all messages ACKed
    - `TestFlush_NAKOnWriteError`: flush fails (S3 error), all messages NAKed
    - `TestProcessMessage_UnmarshalError_TermsMessage`: invalid proto data, msg.Term() called
    - `TestProcessMessage_AddsToTrackedBatch`: valid event added as trackedEvent with msg reference
    - `TestStop_FinalFlush`: stop triggers final flush of remaining batch
    - Note: These tests require mocking the S3 client and Parquet writer. Create interfaces for these dependencies if they don't already exist, or use the simplest mock possible.

    **`internal/compaction/internal/service/compaction_service_test.go`:**
    - `TestCompactPartition_MergesSmallFiles`: mock S3 with 3 small files, compaction produces 1 file, originals deleted
    - `TestCompactPartition_SkipsLargeFiles`: files above target size are not included in merge
    - `TestCompactPartition_MinFilesThreshold`: fewer than minFiles small files, no compaction
    - `TestListPartitions_ExcludesCurrentHour`: current hour partition not included
    - Note: These tests require mocking S3 operations. Use an interface for S3 client if not already defined.

    **`sdk/go/causality_test.go`:**
    - `TestNew_ValidConfig`: client created successfully
    - `TestNew_MissingAPIKey_ReturnsError`: returns error
    - `TestTrack_SetsIdempotencyKey`: event gets UUID idempotency key
    - `TestTrack_SetsTimestamp`: event gets timestamp if zero
    - `TestTrack_SetsAppID`: event gets default app_id
    - `TestFlush_SendsEvents`: manual flush sends accumulated events
    - `TestClose_FlushesRemainingEvents`: close sends remaining events

    **`sdk/go/transport_test.go`:**
    - Use `httptest.NewServer` to create mock server
    - `TestSendBatch_Success`: server returns 200, no error
    - `TestSendBatch_ServerError_Retries`: server returns 500 twice then 200, succeeds after retry
    - `TestSendBatch_ClientError_NoRetry`: server returns 400, returns error immediately without retry
    - `TestSendBatch_SetsHeaders`: verify X-API-Key and Content-Type headers

    Run all tests:
    ```
    go test ./internal/... && cd sdk/go && go test ./...
    ```

    Check coverage:
    ```
    go test -coverprofile=coverage.out ./internal/...
    go tool cover -func=coverage.out | tail -1
    ```
  </action>
  <verify>
    - `go test ./internal/...` passes
    - `cd sdk/go && go test ./...` passes
    - `go test -race ./internal/...` passes
    - `go test -coverprofile=coverage.out ./internal/... && go tool cover -func=coverage.out | tail -1` shows >= 70% coverage
  </verify>
  <done>
    All Phase 1 modules have unit tests. Gateway validation, middleware, warehouse consumer ACK/NAK, compaction merge, and Go SDK all tested. Coverage >= 70%. All tests pass with race detector.
  </done>
</task>

</tasks>

<verification>
- `go test ./internal/...` — all tests pass
- `cd sdk/go && go test ./...` — all SDK tests pass
- `go test -race ./internal/...` — no data races detected
- `go test -coverprofile=coverage.out ./internal/... && go tool cover -func=coverage.out | tail -1` — total coverage >= 70%
- Test files exist for: auth domain, auth service, dedup domain, dedup service, gateway service, gateway middleware, warehouse consumer, compaction service, SDK client, SDK transport
</verification>

<success_criteria>
- Test coverage >= 70% across internal/ packages
- Auth: key generation, validation, revocation tested
- Dedup: bloom filter, sliding window, concurrent safety tested
- Gateway: event validation, per-key rate limiting, body size limit tested
- Warehouse: ACK-after-write, NAK-on-failure, Term-on-poison tested
- Compaction: merge logic, cold partition filtering, min files threshold tested
- Go SDK: Track, Flush, Close, retry logic tested
- All tests pass with race detector enabled
</success_criteria>

<output>
After completion, create `.planning/phases/01-pipeline-hardening-observability-go-sdk/01-10-SUMMARY.md`
</output>
